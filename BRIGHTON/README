% "this directory" refers to https://github.com/barrycarter/bcapps/blob/master/BRIGHTON/

% I am installing from an old Fedora Core 11 machine (hereafter called
"dullon") using ssh and vncserver to access a my new machine; for
testing, I will create a VM version of it first, and then follow the
same steps to create it in production.

% To create a CentOS 7 machine that runs VirtualBox, see
"bc-install-virtualbox-on-centos7.txt" in this directory.. This
machine is hereafter called "brighton"

% To create a CentOS 7 virtual machine (hereafter called
"babybrighton"), see bc-create-vm-with-virtualbox.txt in this
directory.

% OPTIONAL: on dullon add a line like this to /etc/hosts so you can
access the machine as babybrighton

192.168.0.100 babybrighton

This documents my attempt to setup "brighton", a new CentOS 7.2
machine, first as a VM, and later as a physical machine. My current
machine is running Fedora Core 11, and I will its existing files as a
"fallback" for certain things (eg, binaries and libraries absolutely
not available via CentOS 7.2 or that I am too lazy to install from
tertiary sources) [default install + CentOS 7 included/approved
repositories = primary source, unapproved repositories = secondary
source]

How to read this document:

  - A left flush "%% TODO:" indicates a step I need to do and that is
  not complete yet.

  - A left flush "% IMP:" indicates an important note about the steps
  that follow. You should not follow the steps that come afterwards
  unless you are sure you know what you're doing.

  - A left flush "% NOTE:" indicates a note that is optional reading
  and may explain why a certain step must be performed in a specific
  way and why other reasonable-seeming ways to perform that step may
  not be correct, or a comment on why this step is performed.

  - Any other left flush "% " indicates a step to follow.

% Boot babybrighton in detachable mode and enter disk password

% You no longer need the X window that VirtualBox brings up, so go to
Machine/Detach GUI to get rid of it.

% From dullon, "ssh root@babybrighton"

% I prefer tcsh and many things I do rely on it, so:

yum -y install tcsh
chsh -s /bin/tcsh root
chsh -s /bin/tcsh user

%% TODO: should I move the steps above elsewhere?

% run "make" in this directory on dullon, so the following rsync will
push over yum-runme.sh

% rsync the latest BCGIT to babybrighton (dullon is 192.168.0.2) from
babybrighton itself

yum -y install rsync
: below may not be needed if still running in sh
rehash
rsync -Pavz root@192.168.0.2:/home/barrycarter/BCGIT /home/user/

: and private stuff I still need
rsync -Pavz root@192.168.0.2:/home/barrycarter/BCPRIV /home/user/

% Install X11 as a group

: next line just makes group stuff faster in future

yum groups mark convert

: note this only shows up with "yum grouplist hidden" not w/o "hidden"

yum -y groupinstall "X Window System" multimedia

% Install "approved" repositories

sh ~user/BCGIT/BRIGHTON/repos.sh

% Create cache of meta data (improves speed):

yum makecache

% and install applydeltarpm to possibly speed things up

yum -y install deltarpm

% run yum-runme.sh as follows:

: this does skip approx 3 packages due to dependency issues but nothing serious
sh ~user/BCGIT/BRIGHTON/yum-runme.sh |& tee /tmp/yum-runme.out

% and bc-cpan.sh

sh ~user/BCGIT/BRIGHTON/bc-cpan.sh |& tee /tmp/cpan.out

% Consider snapshotting here as "postmassinstall" UNLESS yun-runme.sh
dies on an error (warnings are ok). As always, "shutdown -h" first.

% If needed (or if restoring snapshot here), rsync over BCGIT again

% Cut and paste results of below into nopkglist.txt: the packages I
want that CentOS doesn't provide:

fgrep "No package " /tmp/yum-runme.out|perl -anle 'print $F[2]'|sort|uniq|less

%% TODO: see bc-start-db.txt (I can't get dbs working, but want to get
their verbiage out of the way)

% create symlinks:

sh ~user/BCGIT/BRIGHTON/bc-symlinks.sh |& tee /tmp/bc-symlinks.out

% Ugly install of fly (older version, newer is broken)

cd /root/build
cp ~user/Downloads/fly-1.6.5.tar.gz .
tar xvfz fly-1.6.5.tar.gz
cd fly-1.6.5
make
cp fly /usr/local/bin/
chmod +x /usr/local/bin/fly
: do not appear to need this
: cp gd1.3/libgd.a /usr/local/lib/

% start the crontab

crontab -u user /home/user/BCGIT/BRIGHTON/bc-public-crontab

% add to /etc/rc.local (TODO: find a better way to do this) to reset
time on reboot (TODO: don't rely on non-NIST server?):

rdate -s utcnist.colorado.edu

% remove unwanted services (no need to "stop" these, since I plan to
reboot anyway)

%% testing below (remember to tweak /etc/network-scripts or wahtever)

ps -ef | fgrep -v '[' | perl -anle 'print $F[7]' | sort -u

: TODO: put these in file

systemctl disable auditd NetworkManager tuned cups wpa_supplicant

: the above die nicely on reboot

systemctl disable irqbalance avahi-daemon vboxadd-service

: the above die nicely (after editing)

systemctl mask gssproxy alsa-state

: all good after above

: testing

systemctl mask systemd-journald systemd-udevd


: the below do NOT die nicely
systemctl disable alsa-state lvm2-lvmetad lvm2-lvmetad.socket


systemd-udevd systemd-logind systemd-journald

systemctl mask gssproxy 




auditd avahi-daemon cups gssproxy irqbalance lvm2-lvmetad


systemctl disable NetworkManager systemd-journald systemd-udevd tuned
systemctl disable wpa_supplicant systemd-journald.socket systemd-logind
systemctl disable lvm2-lvmetad.socket vboxadd-service polkit
systemctl disable systemd-udevd-control.socket systemd-udevd-kernel.socket
systemctl disable alsa-state getty@tty1



%% TODO: am snapshotting (after shutdown) here as "Xable"; if this
really does let me use X normally, keep this snapshot; else tweak (aka
can I xinit login at this point?)

%% TODO: explain how to use mount so babybrighton can edit files
directly on dullon in this directory

%% TODO: compare all lib and bin files from old machine (perhaps using fc11root) and new machine to see what I'm missing

% NOTE: to list all bin and lib files on a machine (which I can use to
compare my current bin files on dullon to those on babybrighton to see
what I'm "missing"):

: there are other /bin and /sbin dirs, but they appear less important
: /bin does not appear directly in CentOS 7, but may on other systems
: /usr/X11R6/bin/ is an archaism from FC11

: of course, these steps could be combined but intermediate files are useful

setenv FOO babybrighton
export FOO="babybrighton"

find /usr/sbin /usr/local/sbin /usr/bin /usr/local/bin /bin /sbin 
 /usr/X11R6/bin/ -type f -o -type l > /tmp/$FOO-binlist0.txt

perl -pnle 's%^.*/%%' /tmp/$FOO-binlist0.txt|sort -u > /tmp/$FOO-binlist1.txt

: can then use comm to compare the two bin lists

%% TODO: above for libs, common names are:

/var/lib /usr/lib /usr/local/lib /lib

%% TODO: consider making this entire document even more specific to me and avoid the "IF THEN" stuff

%% TODO: try to include reference URLs (using Firefox history if
needed) when doing something unusual or difficult

%% TODO: make sure no colon parens and explain why (or go # all the way?)

%% TODO: explain ":" comments

%% TODO: use chkconfig/systemctl on guest to make sure what I want comes up (ps -auxwww or ps -ef to see whats actually running)

%% TODO: look at TODOs from FEDORA and CENTOS and VM

%% TODO: configure /etc/hosts on babybrighton

% DONE: symlink urxvt to rxvt

%% TODO: put "significant legacy" note in this dir, ../CENTOS* ../VM/ and ../FEDORA

%% TODO: figure out why /usr/local/bin/surl did to not get transferred
to /fc11oldroot from dullon or whatever (and redo this rsync to keep up?)

%% TODO: consider virtualizing dullon so I can cut over to new machine ASAP

%% TODO: more cpan stuff

%% TODO: fixed IP addr, no NetworkManager

%% TODO: at some point, decide how much to put in shell scripts and
how much to run manually (stuff that needs pw or that I want to verify
= manually?)

%% TODO: create precedence level for TODO, and don't require user to
stop for minor ones (or move minor TODO to end)

%% TODO: note cutover steps when I must stop making changes on dullon and start making changes only on brighton

%% TODO: check each job in cron is actually working

%% REF: /usr/lib/systemd/system

%% REF: https://www.freedesktop.org/software/systemd/man/systemd.unit.html

%% TODO: why is elinks coming up black/white not in color?

%% TODO: why does login still say "home dir NA, using /" even when I
own homedir (even does this for root) and it exists (deferred mounting?!)

%% TODO: at what point during login do "group permissions" kick in??

%% TODO: review brighton-procs.txt

%% TODO: make sure daemon-checker complains properly when mysqld not
running (it wasn't for some reason earlier)

%% TODO: set default timezone

%% TODO: instead of installing unavailables from source, consider
using RPMs, but test them and don't let them break anything else
(rpmfind.net?); also, if reinstalling multiple times dont dl the same
RPM repeatedly (store on big drive and check before re-dling)

% REF: when adjusting volume on guests, make sure volume is correct on
brighton, host, as well (serious problems if not)

%% TODO: whine about default CentOS7 not enable network (+ not even
showing option until you choose partitioning) -- maybe take screenshot

%% TODO: disclaim why I'm using VirtualBox over KVM (/dev/sdb only!)

%% TODO: merge CENTOS/FEDORA/BRIGHTON dirs into one semi-coherent mass

%% TODO: disclaim everything

%% TODO: babybrighton doesnt seem to keep time well, keep an eye on this

%% TODO: change .100 to .3 if networking-scripts file when going live
