% "this directory" refers to https://github.com/barrycarter/bcapps/blob/master/BRIGHTON/

% I am installing from an old Fedora Core 11 machine (hereafter called
"dullon") using ssh and vncserver to access a my new machine; for
testing, I will create a VM version of it first, and then follow the
same steps to create it in production.

% To create a CentOS 7 machine that runs VirtualBox, see
"bc-install-virtualbox-on-centos7.txt" in this directory.. This
machine is hereafter called "brighton"

% To create a CentOS 7 virtual machine (hereafter called
"babybrighton"), see bc-create-vm-with-virtualbox.txt in this
directory.

%% TODO: whine about default CentOS7 not enable network (+ not even
showing option until you choose partioning) -- maybe take screenshot

%% TODO: disclaim why I'm using VirtualBox over KVM (/dev/sdb only!)

%% TODO: merge CENTOS/FEDORA/BRIGHTON dirs into one semi-coherent mass

%% TODO: disclaim everything

This documents my attempt to setup "brighton", a new CentOS 7.2
machine, first as a VM, and later as a physical machine. My current
machine is running Fedora Core 11, and I will its existing files as a
"fallback" for certain things (eg, binaries and libraries absolutely
not available via CentOs 7.2 or that I am too lazy to install from
tertiary sources) [default install + CentOS 7 included/approved
repositories = primary source, unapproved repositories = secondary
source]

How to read this document:

  - A left flush "%% TODO:" indicates a step I need to do and that is
  not complete yet.

  - A left flush "% IMP:" indicates an important note about the steps
  that follow. You should not follow the steps that come afterwards
  unless you are sure you know what you're doing.

  - A left flush "% NOTE:" indicates a note that is optional reading
  and may explain why a certain step must be performed in a specific
  way and why other reasonable-seeming ways to perform that step may
  not be correct, or a comment on why this step is performed.

  - Any other left flush "% " indicates a step to follow.

% Boot babybrighton in detachable mode and enter disk password

% You no longer need the X window that VirtualBox brings up, but I
couldn't find a way to kill it without bringing the system
down. Minimizing it is a half solution.

%% TODO: how to kill window in detachable mode?

% From dullon, "ssh root@babybrighton"

% I prefer tcsh and many things I do rely on it, so:

yum -y install tcsh
chsh -s /bin/tcsh root
chsh -s /bin/tcsh user

% follow steps in bc-move-root.txt if desired

% run "make" in this directory, so the following rsync will push over
yum-runme.sh

% rsync the latest BCGIT to babybrighton (dullon is 192.168.0.2)

yum -y install rsync
rehash
rsync -Pavz root@192.168.0.2:/home/barrycarter/BCGIT /home/user/

% Install X11 as a group

: next line just makes group stuff faster in future
yum groups mark convert

yum -y groupinstall "X Window System"

% Install "approved" repositories

sh ~user/BCGIT/BRIGHTON/repos.sh

% run yum-runme.sh as follows:

sh ~user/BCGIT/BRIGHTON/yum-runme.sh |& tee /tmp/yum-runme.out

% Above wont install many packages, but, unless it actually breaks
(ie, yum yields an error, not just warnings), you may wish to snapshot
"alpha" here [to be safe "shutdown -h" first though]

% Cut and paste results of below into nopkglist.txt: the packages I want that CentOS 

%% TODO: how to update nopkglist.txt

%% TODO: rsync over private files too, but perhaps create a subdir first

%% TODO: rename fc11root as such

% NOTE: to list all bin and lib files on a machine (which I can use to
compare my current bin files on dullon to those on babybrighton to see
what I'm "missing"):

: there are other /bin and /sbin dirs, but they appear less important
: /bin does not appear directly in CentOS 7, but may on other systems
: /usr/X11R6/bin/ is an archaism from FC11

: of course, these steps could be combined but intermediate files are useful

setenv FOO babybrighton
export FOO="babybrighton"

find /usr/sbin /usr/local/sbin /usr/bin /usr/local/bin /bin /sbin 
 /usr/X11R6/bin/ -type f -o -type l > /tmp/$FOO-binlist0.txt

perl -pnle 's%^.*/%%' /tmp/$FOO-binlist0.txt|sort -u > /tmp/$FOO-binlist1.txt

: can then use comm to compare the two bin lists

%% TODO: above for libs, common names are:

/var/lib /usr/lib /usr/local/lib /lib







%% TODO: consider making this entire document even more specific to me and avoid the "IF THEN" stuff

%% TODO: in primary README, give statement of purpose for this git repo

%% TODO: try to include reference URLs (using Firefox history if
needed) when doing something unusual or difficult

% When installing CentOS 7 on babybrighton:

  - Under "network", turn on Ethernet, name machine babybrighton

  - Under Configure/Ethernet, set MAC address to 08:00:00:00:00:00 or
  something else easy to recognize and configure your router/DHCP to
  give this a specific IP address and add that IP address to
  /etc/hosts for convenience. Example (to add to /etc/hosts):

192.168.0.100 babybrighton 

: reboot virutal machine and then below on brighton

: immediately after reboot, "shutdown -h" babybrighton and do this on brighton:

virsh snapshot-create-as babybrighton postinstall "Post installation"

: restart babybrighton



% After restarting babybrighton, do this on brighton so I can do all
the "cryptsetup" stuff on babybrighton, not on brighton itself (I want
to make babybrighton as close a match as possible, so have it do the
cryptsetup stuff is better than doing it in the host)

virsh attach-disk --persistent babybrighton /dev/sdb vdb

virsh attach-disk --persistent babybrighton /dev/sdb vdb --type disk

: opposite is "virsh detach-disk babybrighton vdb"

: "virsh domblklist babybrighton" lists disks

# snapshot-current snapshot-edit snapshot-info snapshot-list 


% Now, "ssh root@babybrighton" for the next steps

: this lets me use ../CENTOS/move-root.txt as it stands
ln -s /dev/vdb3 /dev/sdb3

: this is an ugly instance of having to install something early

yum -y install cryptsetup

% Follow ../CENTOS/move-root.txt if making alternate disk main disk;
if doing this, also make a snapshot (from brighton AFTER shutting down
babybrighton):

virsh snapshot-create-as babybrighton postdisk "post external disk"

: restart babybrighton

% NOTE: virsh snapshot-revert babybrighton postinstall






%% TODO: make sure no colon parens and explain why





% IMP: stop here, steps below are for older

% Use virtualbox's repo

curl -o /etc/yum.repos.d/virtualbox.repo http://download.virtualbox.org/virtualbox/rpm/rhel/virtualbox.repo

% Install virtualbox, accepting GPG keys as necessary (can also use "-y"?)

yum -y install VirtualBox-5.1;: may need to verify some keys manually

% You CAN run VirtualBox from the command line, but it's sort of a
pain, so let's create a quick and easy X11 environment:

: GNOME the "yum groupinstall hidden" "X Window System" may work here too
yum -y groupinstall "KDE Plasma Workspaces";: this is overkill but it works



%% TODO: disclaim that CentOs7 actually has virtualization built in
(eg, "yum groupinstall 'Virtualization Host'"), but that we're using
virt as an intermediate step, so I am OK with "cheating"

: note "yum grouplist hidden" will show "X Window System" but wont w/o hidden

: note you probably could just install 


%% TODO: note use of ;: as comments

% IMP: this is incomplete

%% TODO: more
  

Steps start with left flush "%", but left flus"% NOTE:" indicates a note, not a step 

%% TODO: tell how I got to VirtualBox state

%% TODO: runme.sh for setup

%% TODO: Guest Box additions required to access main disk

%% TODO: can I encrypt /dev directly from vbox?

%% TODO: add repos

%% TODO: which programs can i NOT install from repos

%% TODO: hooking (linking) in old bin and lib and root from fc11root (and
.tcshrc files required) (PATH and LD_LIBRARY_PATH) but as last entries

%% TODO: fossies mention for source code where needed (but not the best, other sources more complete)

%% TODO: use chkconfig/systemctl on guest to make sure what I want comes up (ps -auxwww or ps -ef to see whats actually running)

%% TODO: note that installing centos7 w/ all the repos/rpms I select
requires more than the default 8gb drive virtualbox gives (although
I'm now using KVM, but think it's default is too small too) --
recommend give as much space as possible, but maybe df -kh after full install

%% TODO: look at TODOs from FEDORA and CENTOS and VM

%% TODO: compare new bin dirs with old ones to see what is missing and will fallthru

% NOTE: info I may need to install guest additions:

: or equivalent in tcsh
export KERN_INCL=/usr/include
export KERN_DIR = /usr/src/kernels/3.10.0-327.36.3.el7.x86_64

%% TODO: add aliases file

%% TODO: pwless root for wheel
