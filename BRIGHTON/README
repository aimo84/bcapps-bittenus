%% TODO: find minimal configuration to bring up virtualbox (using a VM
to do this and then will mirror to live drive) and allowing me to VNC
into it [actually it needn't be minimal-- of course I could ssh tunnel
into VNC, ssh -X into machine, or even work on console directly, but I
prefer remote VNC]

: this step is optional -- it will create groups, but so will the next command
: if you dont run this one
yum -y grouplist

: install desktop
yum -y groupinstall "GNOME Desktop"

: get virtualbox repo
curl -o /etc/yum.repos.d/virtualbox.repo http://download.virtualbox.org/virtualbox/rpm/rhel/virtualbox.repo

: and install virtualbox
: xterm needed for GNOME desktop, but not installed sigh
: vnc so I can access it remotely
yum -y install VirtualBox-5.1 xterm tigervnc-server

% tigervnc-server turns on the firewall, blocking incoming vnc; to fix:

systemctl disable firewalld

% and set a password so it comes up automatically at reboot
vncpasswd

% Due to a hideous oversight by CentOS, GNOME/gdm doesnt come up
automatically on reboot and "xinit" starts with on window manager. A
partial fix is to put this line in ~/.xinitrc (which is probably
empty, the first line is to start vnc):

vncserver &
exec gnome-shell

% reboot, login, and run "xinit &"

% you can now vnc into this machine and run virtualbox (note: if you
were using a VM to test how to get CentOS7 to run virtualbox, you
should follow the procedure above on the physical machine-- running
virtualbox inside a virtual machine is unwise [though apparently
possible])


% do this to bring up KDE:

yum -y grouplist
: purely because I want to see what KDE looks like, other desktops ok too
yum -y groupinstall "KDE Plasma Workspaces"

: get virtualbox repo
curl -o /etc/yum.repos.d/virtualbox.repo http://download.virtualbox.org/virtualbox/rpm/rhel/virtualbox.repo



: and then reboot

%% TODO: disclaim why I'm using VirtualBox over KVM (/dev/sdb only!)

%% TODO: merge CENTOS/FEDORA/BRIGHTON dirs into one semi-coherent mass

%% TODO: disclaim everything

This documents my attempt to setup "brighton", a new CentOS 7.2
machine, first as a VM, and later as a physical machine. My current
machine is running Fedora Core 11, and I will its existing files as a
"fallback" for certain things (eg, binaries and libraries absolutely
not available via CentOs 7.2 or that I am too lazy to install from
tertiary sources) [default install + CentOS 7 included/approved
repositories = primary source, unapproved repositories = secondary
source]

How to read this document:

  - A left flush "%% TODO:" indicates a step I need to do and that is
  not complete yet.

  - A left flush "% IMP:" indicates an important note about the steps
  that follow. You should not follow the steps that come afterwards
  unless you are sure you know what you're doing.

  - A left flush "% NOTE:" indicates a note that is optional reading
  and may explain why a certain step must be performed in a specific
  way and why other reasonable-seeming ways to perform that step may
  not be correct, or a comment on why this step is performed.

  - Any other left flush "% " indicates a step to follow.

% IMP: the following apply to physical hardware on which the host
machine will reside.

% Install CentOS-7-x86_64-Minimal-1511.iso (sha256 sum:
f90e4d28fa377669b2db16cbcb451fcb9a89d2460e3645993e30e137ac37d284) on a
USB stick or other install medium.

% Choose the default settings, but do turn on networking; create a
root user with a trivial password and an administrative "user" user
with no password. There is no need to encrypt the data or choose a
specific partioning scheme, since we will only be using this install
to startup a virtual machine.

% After rebooting, "ssh root@brighton"

% NOTE: you won't be able to ssh in as the passwordless "user" user,
and we'll need to be root for the next steps anyway.

% NOTE: "yum grouplist" shows some groups, "yum grouplist hidden" shows all

% Install KVM + X11

yum -y groupinstall "Virtualization Host" "X Window System"

% and now a way to view it (the default X11 files installed require
xterm but don't install it, grumble):

yum -y install virt-manager xterm

: start up X
xinit &

% IMP: I'm having difficulty getting VNC setup consistently, so the
steps below may not work; in particular:

  - you may not need both xinit and vncserver (though x0vncserver may work)

  - turn off (or modify) firewall or use ssh ("systemctl stop
  firewalld" is easiest)

% If you plan to access brighton remotely, follow these steps;
otherwise, skip to next %

yum -y install tigervnc-server

: note rpm -ql tigervnc-server shows what this actually installed

: note "vncserver --help" which references "Xvnc -help" are helpful here

vncserver &

: "netstat -a" shows vncserver listens on 5901, not 5900 or at least
: mine does, so I had to do "vncviewer -geometry 1024x768 brighton:5901"
: which I found annoying

: for some reason, "X Window System" doesnt install a window manager,
: so let's do that now

yum -y install kwin

: run this from brighton, if running remotely must set DISPLAY
kwin &

% Get VM running

systemctl start libvirtd

: get a copy of CentOS-7-x86_64-Minimal-1511.iso into /var/lib/libvirt/images/

: install using virt-manager giving plenty of disk space
: give as much disk space as possible (I gave 47G)

: if doing this via ssh and vnc, remember to "export DISPLAY=:1" or
: equivalent --vncserver should tell you what this is after it starts--

virt-manager &

% When installing CentOS 7 on babybrighton:

  - Under "network", turn on Ethernet, name machine babybrighton

  - Under Configure/Ethernet, set MAC address to 08:00:00:00:00:00 or
  something else easy to recognize and configure your router/DHCP to
  give this a specific IP address and add that IP address to
  /etc/hosts for convenience. Example (to add to /etc/hosts):

192.168.0.100 babybrighton 

: reboot virutal machine and then below on brighton

: immediately after reboot, "shutdown -h" babybrighton and do this on brighton:

virsh snapshot-create-as babybrighton postinstall "Post installation"

: restart babybrighton



% After restarting babybrighton, do this on brighton so I can do all
the "cryptsetup" stuff on babybrighton, not on brighton itself (I want
to make babybrighton as close a match as possible, so have it do the
cryptsetup stuff is better than doing it in the host)

virsh attach-disk --persistent babybrighton /dev/sdb vdb

virsh attach-disk --persistent babybrighton /dev/sdb vdb --type disk

: opposite is "virsh detach-disk babybrighton vdb"

: "virsh domblklist babybrighton" lists disks

# snapshot-current snapshot-edit snapshot-info snapshot-list 


% Now, "ssh root@babybrighton" for the next steps

: this lets me use ../CENTOS/move-root.txt as it stands
ln -s /dev/vdb3 /dev/sdb3

: this is an ugly instance of having to install something early

yum -y install cryptsetup

% Follow ../CENTOS/move-root.txt if making alternate disk main disk;
if doing this, also make a snapshot (from brighton AFTER shutting down
babybrighton):

virsh snapshot-create-as babybrighton postdisk "post external disk"

: restart babybrighton

% NOTE: virsh snapshot-revert babybrighton postinstall






%% TODO: make sure no colon parens and explain why





% IMP: stop here, steps below are for older

% Use virtualbox's repo

curl -o /etc/yum.repos.d/virtualbox.repo http://download.virtualbox.org/virtualbox/rpm/rhel/virtualbox.repo

% Install virtualbox, accepting GPG keys as necessary (can also use "-y"?)

yum -y install VirtualBox-5.1;: may need to verify some keys manually

% You CAN run VirtualBox from the command line, but it's sort of a
pain, so let's create a quick and easy X11 environment:

: GNOME the "yum groupinstall hidden" "X Window System" may work here too
yum -y groupinstall "KDE Plasma Workspaces";: this is overkill but it works



%% TODO: disclaim that CentOs7 actually has virtualization built in
(eg, "yum groupinstall 'Virtualization Host'"), but that we're using
virt as an intermediate step, so I am OK with "cheating"

: note "yum grouplist hidden" will show "X Window System" but wont w/o hidden

: note you probably could just install 


%% TODO: note use of ;: as comments

% IMP: this is incomplete

%% TODO: more
  

Steps start with left flush "%", but left flus"% NOTE:" indicates a note, not a step 

%% TODO: tell how I got to VirtualBox state

%% TODO: runme.sh for setup

%% TODO: Guest Box additions required to access main disk

%% TODO: can I encrypt /dev directly from vbox?

%% TODO: add repos

%% TODO: which programs can i NOT install from repos

%% TODO: hooking (linking) in old bin and lib and root from fc11root (and
.tcshrc files required) (PATH and LD_LIBRARY_PATH) but as last entries

%% TODO: fossies mention for source code where needed

%% TODO: use chkconfig/systemctl on guest to make sure what I want comes up (ps -auxwww or ps -ef to see whats actually running)

%% TODO: programs I want that dont appear to have packages:

celestia
dosemu (check: does dosbox include this implicitly?)
FBReader
gnumeric
maxima
ntop
openuniverse 

%% TODO: note that installing centos7 w/ all the repos/rpms I select
requires more than the default 8gb drive virtualbox gives (although
I'm now using KVM, but think it's default is too small too) --
recommend give as much space as possible, but maybe df -kh after full install

%% TODO: look at TODOs from FEDORA and CENTOS and VM

%% TODO: compare new bin dirs with old ones to see what is missing and will fallthru

% NOTE: info I may need to install guest additions:

: or equivalent in tcsh
export KERN_INCL=/usr/include
export KERN_DIR = /usr/src/kernels/3.10.0-327.36.3.el7.x86_64
