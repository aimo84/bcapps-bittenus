TODO: add disclaimer re these are my experiences AND you should not
follow instructions blindly AND especially not run commands blindly
AND especially not as root. No intentional malicious code, but blindly
running stuff hurts you and other-- botnet

TODO: note that I focus on LVM thingy but most people won't run into
it unless they try to install one on media first another media later

NOTE: any reference to "this directory" or "here" refers to
https://github.com/barrycarter/bcapps/blob/master/FEDORA/

NOTE: the "local" machine is the one to which you are installing
Fedora 24; the "remote" machine is any Linux machine from which you
are performing the install.

NOTE: I will sometimes refer to "Fedora 24" as "Fedora Core 24"
because many of the package names still have "fc24" in them.

NOTE: during graphical boot, hit ESC to see what system is actually doing

NOTE: if any step fails, reboot and try to backup (or reinstall) to
the failing step

NOTE: in some cases, ssh to brighton works even during bootup error

NOTE TO SELF: I have Fedora 24 installed to both P0: and P2: but
should boot from P0: if not automatic

NOTE: some of my commands in both this file and other files in this
directory either print out something you can pipe to sh or use options
like rsync's "-n" to do test runs. This is so you can see what a
command does before actually running it. When ready to run, either
pipe to sh or remove the dry run option as applicable

NOTE: just after initial install, you won't have many editors
available (probably just ex and vi), so I give commands like:

echo something >> filename

In reality, you should always look at filename to make sure you're not
destroying anything. If you want to "cheat", you may choose to install
a better editor before continuing installation.

%% TODO: disclaim order of steps, multiple tries [or do additional
reinstalls to test final file]

%% TODO: last minute final sync from old machine to brighton, after
all filechanging processes have been stopped forever

%% TODO: remove redundant entries in BIOS

%% TODO: move files in this directory to the proper places on brighton
(or symlink) [many done, but need to make sure all done]

This document describes how I (mostly remotely) created a minimal
Fedora 24 system (no gnome, no evolution, no unnecessary daemons)
running fvwm2

Download Fedora 24 from
https://getfedora.org/en/workstation/download/, burn it to a DVD or
USB stick, and boot from the DVD or USB stick. When prompted, click
"Install" to install Fedora 24 on your hard disk.

Create a root password and another user (called "user") with no password.

OPTIONAL: if you are installing Fedora to a solid-state drive (SSD),
and want the /home and /root directories on another drive, partition
as follows:

  - Set the /home partition to 5GiB. We will symlink to the big drive
  drive later.

  - Delete the swap partition; we will create it below later

  - Leave the /boot and /boot/efi partitions as is.

  - Give the remaining space to the / partition, but leave at least
  20GiB: you probably won't need it, but the dnf installs below total
  ~9GiB, so you just might if you install even more stuff.

After removing the installation media and rebooting, login as
user. You will now be in the GNOME environment. Now:

% Go to the top right of the screen, click the down arrow, and choose
the settings icon at the bottom left of the pulldown menu.

% Select "Sharing", and turn on Sharing in general and "Remote Login"
specifically (even though you're logged in as the passwordless 'user'
account, this will turn on ssh for root)

% On your remote machine (not the one on which you're installing Fedora
Core 24), add the machine's IP address to /etc/hosts something like
this:

192.168.0.3 brighton

This will let you refer to the machine as "brighton" instead of having
to type out the IP address each time. Of course, make sure you use the
machine's actual IP address, which probably won't be 192.168.0.3 in
your case.

% "ssh root@brighton" to login remotely as root

% OPTIONAL: If you have an encrypted non-boot drive (I'm naming mine
kemptown), do the following (note use your LVM's actual name below--
if you previously tried installing fedora this other drive, your LVMs
will have the same name, which you will have to fix-- see
"lvm-name-conflict.txt" in this directory):

: initially, there is no "/etc/cryptsetup" and "/etc/crypttab" reads:

: luks-id-of-root-partition UUID=id-of-root-partition none

cryptsetup open /dev/sdb3 kemptown
less /etc/cryptsetup
echo "luks /dev/sdb3 -" > /etc/cryptsetup
less /etc/crypttab
blkid | fgrep /dev/sdb3
: this must be an append, since main drive should appear there first
echo "luks UUID=the-uuid-given-by-blkid-for-dev-sdb3 none" >> /etc/crypttab
echo "/dev/mapper/oldfedora-home /mnt/kemptown ext4 defaults,x-systemd.device-timeout=30 60 90" >> /etc/fstab
mkdir /mnt/kemptown
mount /mnt/kemptown

% If you installed Fedora on your large internal drive first and then
tried to move the installation to an SSD drive, the steps above may
not work properly: read lvm-name-conflict.txt in this directory to continue

%% create swapspace on /mnt/kemptown/swapspace (TODO: there may be
better ways of doing this but I'm wary of messing w/ my 8TB drive
since I've copied stuff over and made changes)

dd if=/dev/zero of=/mnt/kemptown/swap bs=1000000000 count=128 status=progress&
mkswap /mnt/kemptown/swap
less /etc/fstab
echo "/mnt/kemptown/swap swap swap defaults 0 0" >> /etc/fstab
swapon /mnt/kemptown/swap
: below as recommended
chmod 0600 /mnt/kemptown/swap

% OPTIONAL: move user's home to /mnt/kemptown:

: if below reports "userdel: user user is currently used by process
: xxxx", kill process xxxx (potentially repeatedly) until the command
: succeeds

userdel user;
find /home/user -type f
: above should be tiny(ish)
rm -rf /home/user;
useradd -d /mnt/kemptown/user -g wheel -u 1000 user
passwd user
ln -s /mnt/kemptown/user /home
: move root over as well
mv /root /root.old
ln -s /mnt/kemptown/root /root

% From remote machine, rsync over BCGIT to brighton, since I will use
: symlinks to get things in their proper place

\rsync -Pav /home/barrycarter/BCGIT user@brighton:/home/user/

: and rsync over my private crontab, one of the few files not in this directory

\rsync -Pav /home/barrycarter/bc-private-crontab user@brighton:/home/user/

: seriously consider removing /root/.cpan to avoid screwing up the cpan install

: and then run the commands in runme.sh
: below should do everything automatically, but MAY require user intervention

sudo sh -c 'sh -v /home/user/BCGIT/FEDORA/runme.sh 1>/runme.out 2>/runme.err'&

%% NOTE TO SELF: build on 20161125.013948 is corrupted-- I interuppted
above to rm -rf /root/.cpan, so run at least once more

% stop selinux by editing "SELINUX=enforcing" to "SELINUX=permissive"
in /etc/selinux/config as root (changes will take place on next
reboot) (TODO: this doesn't really stop it like "disabled" would, but
actually seems to work better according to some)

% things we must build manually (not in any good repo)

: NOTE: must install fly 1.6.5 -- version 2.0.1 breaks bc-bg.pl methodology
: get fly from link on http://www.w3perl.com/fly/installation.html
cd /root/build
cp ~user/Downloads/fly-1.6.5.tar.gz .
tar xvfz fly-1.6.5.tar.gz
cd fly-1.6.5
make
cp fly /usr/local/bin/

% I prefer the tcsh for both user and root though some believe this
isn't a good idea (so not putting in runme.sh):

chsh -s /bin/tcsh root
chsh -s /bin/tcsh user

% NOT WORKING: To setup passwordless ssh/rsync, add remote ssh key (in ~/.ssh/id_dsa.pub or similar on remote machine) to ~/.ssh/authorized_keys

% reboot ("shutdown -r now") to bring up the system clean

% you will come up a "localhost login" or similar prompt, not a
windows environment (you don't actually need to login locally)

% Remotely, "ssh user@brighton" and start xinit& (TODO: this probably
won't actually work -- must be at console to xinit&, but can then
vncviewer in)

%% TODO: consider moving pgsql and mysql dirs to 8TB drive

% INFO: you can use the following to see which services are still running:

systemctl -t service | egrep 'loaded +active +running'

% INFO: use "ps -ef | fgrep -v '['" to see the few remaining
(nonbracketed) processes. You CANNOT safely kill or remove any of these
(including "(sd-pam)")

% then, remotely "ssh user@brighton" and then "sudo su" again

% setup passwordless login FROM remote to local machine (so I can
rsync in crontab passwordlessly); if you don't already have an RSA key
(do this as user, it's more flexible):

ssh-keygen -t rsa -b 2048 -f /home/user/.ssh/id_rsa

(with no passphrase, since you'll need it for automated tasks)

%% TODO: find and reinstall parallel version that uses stdin

%% TODO: why not "dnf install '*'"?

%% TODO: tweak local machine /etc/hosts file since many of my aliases
depend on short hostnames (or tweak aliases)

%% OPTIONAL: install sources of everything I've got installed and
their dependencies (excluding those things that "dnf list installed"
gives but aren't actually packages)

: if using SSD, make these symlinks on big drive
mkdir /root/dnf-sources
cd /root/dnf-sources
: see dnf-source-exclusions.txt in this directory
dnf list installed|perl -anle 'print $F[0]'|sort -u|fgrep -vf dnf-source-exclusions.txt | xargs dnf download --source
rpm -i *.rpm
: the results are in /root/rpmbuild/SOURCES/

% INFO: to see how much space dnf installed packages take up:

: note that I could make this a pipe but its useful to do in steps
dnf list installed|perl -anle 'print $F[0]'|sort -u > /tmp/dnf-installed.txt
xargs rpm -ql < /tmp/dnf-installed.txt | sort | uniq > /tmp/dnf-files.txt
xargs wc -c < /tmp/dnf-files.txt | egrep ' total$' |tee /tmp/dnf-wc-totals.txt

: for me this is 8786074786 or about 8.8 GiB

% edit /etc/mail/sendmail.mc

define(`SMART_HOST', `smtp.comcast.net')dnl

% NOTE: you can run "make" after the above (in /etc/mail), but
starting sendmail does this automatically

% import postgres data

: on current machine
pg_dumpall > pgsql-super-dump.txt
: rsync over to brighton (not shown)
: on brighton
sudo -u postgres psql < /tmp/pgsql-super-dump.txt
: "psql -d main" should now work as "user"

% import mysql data

: on current machine
mysqldump --all-databases > mysql-super-dump.txt
: rsync over to brighton (not shown)
sudo mysql < /tmp/mysql-super-dump.txt

%% TODO: mysql, even with dump above, does not appear to have same
users; however "mysql -u root" works as user

% OK to rsync over /etc/httpd/conf and /etc/httpd/conf.d but not other
httpd related files. Comment out any lines like (use "apachectl
configtest" to find these):

# LoadModule authn_file_module modules/mod_authn_file.so
# LoadModule authn_alias_module modules/mod_authn_alias.so
# LoadModule authn_anon_module modules/mod_authn_anon.so
# LoadModule authn_dbm_module modules/mod_authn_dbm.so
# LoadModule authn_default_module modules/mod_authn_default.so

# LoadModule authz_host_module modules/mod_authz_host.so
# LoadModule authz_user_module modules/mod_authz_user.so
# LoadModule authz_owner_module modules/mod_authz_owner.so
# LoadModule authz_groupfile_module modules/mod_authz_groupfile.so
# LoadModule authz_dbm_module modules/mod_authz_dbm.so
# LoadModule authz_default_module modules/mod_authz_default.so

# LoadModule disk_cache_module modules/mod_disk_cache.so

% In /etc/httpd/conf.d, remove (or move to DISABLED subdir) mod_dnssd.conf

: remove -n for production
\rsync -avxn /etc/httpd/conf /etc/httpd/conf.d root@brighton:/etc/httpd/

% Reboot once again, login, run "sh startup-nox.csh" and "xinit &"

% You can then return to remote access using "vncviewer -geometry
1024x768 brigton&"

%% TODO: copy my .fvwm2rc file over into this dir after I get it
working right on brighton live editing

%% TODO: post this to wp with a link to github; google doesn't index
github well

%% TODO: passwordless cross machine ssh (and thus rsync)

% DONE: get dnsmasq working

%% TODO: consider wiping /root/.cpan before running cpan command at least once (garbage?)

%% TODO: find information command for listing which cpan modules I
have installed (it's "cpan -l", now use it and "dnf list installed" to
print out reports somewhere to make sure they do what they say they
do)

%% TODO: get local httpd working

%% TODO: make sure bcgit alias works

%% TODO: some files still have selinux attrs, remove these?:

brighton:~$ attr -l .
Attribute "selinux" has a 41 byte value for .

: however
Could not get "selinux" for .

%% TODO: fedora assumes same passphrase for multiple encrypted disks?

%% TODO: install and run skype

%% TODO: if copying over cron jobs, change old machine name to new machine name

%% TODO: redirect cron output somewhere useful or setup sendmail properly

%% TODO: setup sendmail properly using comcast servers

%% TODO: get nagios working

%% TODO: check for broken symlinks

%% TODO: check personal file I had for bringing this machine up

% TIP: Found an inconsistenty between dnf-installs.sh and runme.sh;
resolving them as follows and then remove dnf-installs.s

fgrep 'sudo dnf install' dnf-installs.sh | perl -anle 'print join("\n",@F)' | sort | uniq > /tmp/dnf.txt

fgrep 'sudo dnf -y install' runme.sh | perl -anle 'print join("\n",@F)' | sort | uniq > ! /tmp/runme.txt

diff /tmp/dnf.txt /tmp/runme.txt

comm -13 /tmp/runme.txt /tmp/dnf.txt 


