# make file to help back things up using bc-chunk-backup.pl

# exclusions2.txt is a commented/prettified version of the exclusions
# file; this converts it to a usable format and converts 'end of line'
# to nulls, since filenames are terminated with NUL not end of line

exclusions.txt: exclusions2.txt
	egrep -v '^#|^ *$$' exclusions2.txt | perl -pnle 's/\$$/\0/' > exclusions.txt

# list of all files, after normalization
afad.txt: bcunix-converted.txt extdrive-converted.txt extdrive2-converted.txt extdrive3-converted.txt extdrive4-converted.txt extdrive5-converted.txt
	sort -u *-converted.txt > afad.txt

# first list of backup candidates
backup0.txt: afad.txt previouslydone.txt.srt
	join --check-order -v 1 -t '\0' afad.txt previouslydone.txt.srt > backup0.txt

# after exclusions
backup1.txt: backup0.txt exclusions.txt
	egrep -avf exclusions.txt backup0.txt | sort -nr > backup1.txt

# feed it to bc-chunk-backup2.pl
statlist.txt: backup1.txt
	bc-chunk-backup2.pl --debug backup1.txt

# join the final backup list to afad.txt to get actual info on files to backup
files-for-chunk.txt.srt: afad.txt files-to-backup2.txt.srt
	join --check-order -j 1,2 -t '\0' afad.txt files-to-backup2.txt.srt

# TODO: this is ugly, should really loop through drives instead of listing
# them one at a time

bcunix-converted.txt: /bcunix-files.txt
	bc-format2altformat2.pl /bcunix-files.txt > bcunix-converted.txt
extdrive-converted.txt: /mnt/extdrive/extdrive-files.txt
	bc-format2altformat2.pl /mnt/extdrive/extdrive-files.txt > extdrive-converted.txt
extdrive2-converted.txt: /mnt/extdrive2/extdrive2-files.txt
	bc-format2altformat2.pl /mnt/extdrive2/extdrive2-files.txt > extdrive2-converted.txt
extdrive3-converted.txt: /mnt/extdrive3/extdrive3-files.txt
	bc-format2altformat2.pl /mnt/extdrive3/extdrive3-files.txt > extdrive3-converted.txt
extdrive4-converted.txt: /mnt/extdrive4/extdrive4-files.txt
	bc-format2altformat2.pl /mnt/extdrive4/extdrive4-files.txt > extdrive4-converted.txt
extdrive5-converted.txt: /mnt/extdrive5/extdrive5-files.txt
	bc-format2altformat2.pl /mnt/extdrive5/extdrive5-files.txt > extdrive5-converted.txt
